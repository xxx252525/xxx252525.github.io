---
icon: /assets/icon/鱼板.svg
category:
  - 博客
contributors: true
lastUpdated: true
pageview: true
isOriginal: true
date: 2024-12-25
---


# Flash Memory(字库)如何备份

字库就是Flash Memory。

字库通常指以下关键数据：

1. **NVRAM（Non-Volatile Random Access Memory）**：包含 IMEI、WiFi MAC 地址、蓝牙地址等校验信息。
2. **Modem 分区（基带数据）**：存储设备通信相关的驱动程序和配置。
3. **EFS（Encrypting File System）**：高通设备中存储 IMEI、设备标识符等关键信息。
4. **TEE（Trusted Execution Environment）**：存储安全环境数据。
5. **Persist 分区**：保存传感器校准、设备认证等重要数据。

如果你在刷机的过程中出现了基带丢失，那么你将无法使用移动网络。比如出现了基带未知的错误，如图：

![image-20241220130058911](./%E5%A6%82%E4%BD%95%E5%A4%87%E4%BB%BD%E5%AD%97%E5%BA%93.assets/image-20241220130058911.png)



## 基带版本未知错误

基带版本未知有几种情况，分别是：

1. 刷姬失败，刷姬的过程中出现错误，未能正确的刷入基带分区
2. ROM与基带不匹配
3. 某些模块导致出现这种错误，并且无法更改回去
4. 硬件损坏
5. 没有这个硬件
6. EFS分区和NV数据损坏，基带分区损坏

例如，我的3588开发板中的云手机就不存在这个硬件，所以也会出现一些未知错误，如图：

<img src="./%E5%A6%82%E4%BD%95%E5%A4%87%E4%BB%BD%E5%AD%97%E5%BA%93.assets/image-20241220131447127.png" alt="image-20241220131447127" style="zoom:67%;" />



## 判断

如何进行判定呢？

在拨号界面输入 `*#06#` 检查 IMEI：

- IMEI 正常：说明问题可能在基带固件。
- IMEI 丢失：可能是 EFS 或 NV 分区问题、要么就是基带分区加载失败

![image-20241220131709265](./%E5%A6%82%E4%BD%95%E5%A4%87%E4%BB%BD%E5%AD%97%E5%BA%93.assets/image-20241220131709265.png)

查看基带版本：

- 如果显示为“未知”或“无”，说明基带分区损坏。

![image-20241220130058911](./%E5%A6%82%E4%BD%95%E5%A4%87%E4%BB%BD%E5%AD%97%E5%BA%93.assets/image-20241220130058911.png)

综合诊断，说明基带分区出现了问题，只能重新刷入基带分区。



## 解决

解决的方法有两种：

1. 直接重新刷机，清楚手机数据
2. 重新刷入基带模块

刷入基带模块方法很多，可以利用flash刷写工具、可以使用adb、可以使用TWRP等方法。



### 准备工具

**Qualcomm Devices(高通)**：

- QPST（Qualcomm Product Support Tool）

    蓝凑云尊享下载：https://www.ilanzou.com/s/VihyPdDF

- EFS Professional

**MTK Devices(联发科)**：

- SP Flash Tool

    蓝凑云尊享下载：https://www.ilanzou.com/s/SANyPdQg

- MTK Droid Tools

    蓝凑云尊享下载：https://www.ilanzou.com/s/2mnyPdqo

分区访问工具：adb、TWRP



### 备份基带数据

将备份的基带分区（如 `modem.img` 或 `nvram.bin`）复制到设备，如果你的设备是正常的那么直接备份就可以了，如果你的设备已经出现错误，并且没有提前备份，那么可以直接使用ROM包里面的`modem.img`，只有卡刷包里面才能提取出来`modem.img`，线刷包里面是没有的。

![image-20241220143513395](./%E5%A6%82%E4%BD%95%E5%A4%87%E4%BB%BD%E5%AD%97%E5%BA%93.assets/image-20241220143513395.png)

#### 使用adb和dd备份

和基带相关的分区通常是：modem、modemst1、modemst2。使用adb进入shell控制台。

命令如下：

```shell
adb shell                                                                                      
alioth:/ $ su
alioth:/ # ls /dev/block/by-name/
```

![image-20241220143925065](./%E5%A6%82%E4%BD%95%E5%A4%87%E4%BB%BD%E5%AD%97%E5%BA%93.assets/image-20241220143925065.png)

在 A/B 分区设备上，系统会自动切换到当前使用的分区（Slot）。进入手机shell进行操作：

```shell
getprop ro.boot.slot_suffix
```

输出会是 `_a` 或 `_b`，表示当前设备正在使用 `modem_a` 或 `modem_b`。

也可以通过fastboot来进行一个查询，在Windows的powershell中操作如下：

```powershell
fastboot getvar current-slot
```

返回内容如下：

```powershell
< waiting for any device >
current-slot: b
Finished. Total time: 0.003s
```

手动打包img文件：

```shell
adb shell
su
dd if=/dev/block/by-name/modem_a of=/sdcard/modem_a.img
dd if=/dev/block/by-name/modem_b of=/sdcard/modem_b.img
dd if=/dev/block/by-name/modemst1 of=/sdcard/modemst1.img
dd if=/dev/block/by-name/modemst2 of=/sdcard/modemst2.img
```

![image-20241220145319198](./%E5%A6%82%E4%BD%95%E5%A4%87%E4%BB%BD%E5%AD%97%E5%BA%93.assets/image-20241220145319198.png)

打包好了之后传输到电脑做一个备份。

### 恢复基带数据

#### 使用adb和dd恢复

操作如下：

```shell
adb shell
su
dd if=/sdcard/modem_a.img of=/dev/block/by-name/modem_a
dd if=/sdcard/modem_b.img of=/dev/block/by-name/modem_b
dd if=/sdcard/modemst1.img of=/dev/block/by-name/modemst1
dd if=/sdcard/modemst2.img of=/dev/block/by-name/modemst2
```

TWRP：

- 在 TWRP 中选择“恢复”，加载之前备份的文件。

修复权限：

```shell
chmod 600 /dev/block/by-name/modem
```

重启设备，检查基带信息是否恢复。

#### 使用fastboot刷写

将基带文件（如 `modem.img`）放在 fastboot 目录下。

进入 fastboot 模式：

```powershell
adb reboot bootloader
```

刷写基带：

```powershell
fastboot flash modem modem.img
```

然后重启设备：

```powershell
fastboot reboot
```

如果官方固件包中只有一个`modem`文件，而没有单独的`modem_a`、`modem_b`、`modemst1`、`modemst2`等文件，直接刷入单个文件就可以了，和上面的步骤一样。



## 字库备份

主要备份的内容如下：

1. **modem_a.img**：设备的主modem固件。
2. **modem_b.img**：第二个modem固件（如果设备使用双modem架构）。
3. **modemst1**：存储modem状态1的文件。
4. **modemst2**：存储modem状态2的文件。
5. **modem.img**：包含设备的modem固件。
6. **modem.elf**：modem固件的执行代码。
7. **modem.bin**：存储modem固件的二进制文件。
8. **baseband.img**：存储基带固件，包含低层无线电通信协议。
9. **radio.img**：无线电固件文件，管理无线电信号。
10. **radio.elf**：无线电固件的执行代码文件。
11. **radio.bin**：无线电固件的二进制文件。
12. **nvram.img**：设备的非易失性内存（NVM）数据，保存了无线通信的配置和参数。
13. **nvram.md5**：`nvram.img`的校验文件。
14. **props**：包含设备无线电配置的文件，定义设备支持的网络、频段、通信协议等。
15. **wcnss_qcom.cfg**：Qualcomm芯片设备的无线通信配置文件。
16. **pds_mpss.mbn**：包含高通平台的无线通信协议。
17. **mpss.mbn**：高通平台用于基带和无线电通信的固件文件。
18. **libmodem.so**：modem模块的共享库文件，通常用于设备的无线通信管理。
19. **libradio.so**：支持无线电功能的共享库文件。
20. **libwcnss.so**：用于高通设备的无线通信共享库文件。
21. **libaudio.so**：部分设备中与音频相关的无线电模块文件。
22. **firmware.bin**：设备固件的二进制文件，包含设备的无线通信固件。
23. **modem_fw.bin**：特定modem固件文件，包含无线电控制相关的固件。
24. **radio_fw.bin**：无线电固件文件，控制无线电模块的功能。
25. **boot.img**：设备的启动镜像，虽然主要用于启动设备，但可能包含modem或基带相关的文件。
26. **system.img**：包含Android系统文件的映像文件，某些字库文件也可能包含在系统镜像中。
27. **QCS405.img**：高通平台的基带固件文件。
28. **MDM9x35.mbn、MDM9x50.mbn**：高通平台的基带固件文件，分别用于不同型号的设备。
29. **ril**：Radio Interface Layer相关的文件，用于与基带、无线电模块进行通信（虽然它不直接属于字库的一部分，但与字库紧密相关）。
30. **debug.log**：用于调试的日志文件，可能包含基带和无线通信相关的调试信息。
31. **dsp_fw.bin**：用于控制和处理数字信号的固件文件，可能与无线通信相关。

我们不可能单独一一备份这些文件，这里我们需要使用脚本来备份。

访问https://github.com/xxx252525/Android-flash-memory-backup 下载脚本

![image-20241220170544624](./%E5%A6%82%E4%BD%95%E5%A4%87%E4%BB%BD%E5%AD%97%E5%BA%93.assets/image-20241220170544624.png)

脚本上传到手机，或者下载到手机。













